<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Smashers DBMS Tracker (Cloud Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .lecture-checkbox:checked + div { text-decoration: line-through; color: #9ca3af; }
        .lecture-row { transition: all 0.2s ease; }
        .lecture-row:hover { background-color: #f9fafb; }

        .target-row { border-left: 4px solid #3b82f6 !important; background-color: #eff6ff !important; }
        .target-badge { display: none; }
        .target-row .target-badge { display: inline-block; }

        .progress-bar-container { height: 12px; background-color: #e5e7eb; border-radius: 6px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); border-radius: 6px; transition: width 0.5s ease-out; }
        .target-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ef4444; z-index: 10; box-shadow: 0 0 4px rgba(0,0,0,0.3); }

        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #2563eb; background-color: #eff6ff; }

        .remark-card.seen { background-color: #f9fafb; border-color: #e5e7eb; }
        .remark-card.seen .remark-text { color: #9ca3af; text-decoration: line-through; }
        .remark-card.seen .remark-meta { color: #d1d5db; }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 50;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading / Config Warning -->
    <div id="loading-overlay">
        <div class="spinner mb-4" id="loading-spinner"></div>
        <h2 class="text-xl font-bold text-gray-700" id="loading-text">Connecting to Live Database...</h2>
        <p id="config-warning" class="text-red-500 mt-4 hidden text-center max-w-md bg-red-50 p-4 rounded-lg border border-red-200">
            ‚ö†Ô∏è <strong>Configuration Missing</strong><br>
            Please open the <code>index.html</code> file and paste your Firebase Config object in the script tag where indicated.
        </p>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm z-10 flex-none">
        <div class="max-w-5xl mx-auto px-4 py-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-database text-blue-600 mr-2"></i>DBMS Tracker
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full ml-2 font-normal align-middle">
                            <i class="fas fa-wifi mr-1"></i>Live Sync
                        </span>
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Target: Nov 14 ‚Äî Feb 14</p>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <div class="text-xs text-blue-600 font-semibold uppercase">Lectures Done</div>
                    <div class="text-2xl font-bold text-blue-800" id="count-display">--/--</div>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                    <div class="text-xs text-purple-600 font-semibold uppercase">Target Today</div>
                    <div class="text-2xl font-bold text-purple-800" id="target-display">--</div>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <div class="text-xs text-orange-600 font-semibold uppercase">Pace Needed</div>
                    <div class="text-2xl font-bold text-orange-800" id="pace-display">--</div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-xs text-gray-500 font-semibold uppercase">Days Left</div>
                    <div class="text-2xl font-bold text-gray-700" id="days-left-display">--</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="relative pt-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Start (Nov 14)</span>
                    <span id="status-text" class="font-bold">Syncing...</span>
                    <span>End (Feb 14)</span>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-fill" class="progress-bar-fill" style="width: 0%"></div>
                    <div id="target-marker" class="target-line" style="left: 0%" title="You should be here"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white border-b border-gray-200 flex-none">
        <div class="max-w-5xl mx-auto px-4 flex space-x-4 overflow-x-auto">
            <button onclick="window.ui.switchTab('lectures')" id="tab-lectures" class="tab-btn active py-3 px-4 text-sm font-semibold text-gray-600 hover:text-blue-600 focus:outline-none whitespace-nowrap">
                <i class="fas fa-list-ul mr-2"></i>Lecture List
            </button>
            <button onclick="window.ui.switchTab('concepts')" id="tab-concepts" class="tab-btn py-3 px-4 text-sm font-semibold text-gray-600 hover:text-blue-600 focus:outline-none whitespace-nowrap">
                <i class="fas fa-brain mr-2"></i>Concepts
            </button>
            <button onclick="window.ui.switchTab('remarks')" id="tab-remarks" class="tab-btn py-3 px-4 text-sm font-semibold text-gray-600 hover:text-blue-600 focus:outline-none whitespace-nowrap">
                <i class="fas fa-chalkboard-teacher mr-2"></i>Mentor Remarks
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="flex-grow overflow-y-auto bg-gray-50">
        <div class="max-w-5xl mx-auto px-4 py-6">
            
            <!-- Lecture List -->
            <div id="view-lectures" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center sticky top-0 z-10">
                    <h2 class="font-semibold text-gray-700">Lecture List</h2>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Gate Smashers</span>
                </div>
                <ul id="lecture-list" class="divide-y divide-gray-100"></ul>
            </div>

            <!-- Concepts -->
            <div id="view-concepts" class="hidden">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Add New Concept</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-concept-title" placeholder="Title" class="flex-1 rounded-md border-gray-300 shadow-sm border px-3 py-2 text-sm">
                        <input type="text" id="new-concept-desc" placeholder="Description" class="flex-1 rounded-md border-gray-300 shadow-sm border px-3 py-2 text-sm hidden sm:block">
                        <button onclick="window.app.addConcept()" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">Add</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <div class="p-4 border-b border-gray-100 bg-indigo-50 flex justify-between items-center">
                        <h2 class="font-semibold text-indigo-900">Major Concepts Checklist</h2>
                    </div>
                    <ul id="concepts-list" class="divide-y divide-gray-100"></ul>
                </div>
            </div>

            <!-- Remarks -->
            <div id="view-remarks" class="hidden">
                <div class="h-full flex flex-col space-y-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Post a New Remark</h3>
                        <textarea id="new-remark-text" class="w-full p-3 border border-gray-300 rounded-lg text-sm resize-none" rows="2" placeholder="Feedback or notes..."></textarea>
                        <div class="mt-2 flex justify-end">
                            <button onclick="window.app.postRemark()" class="bg-amber-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-700">Post</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex-grow overflow-hidden flex flex-col">
                         <div class="p-4 border-b border-gray-100 bg-amber-50 flex justify-between items-center">
                            <h2 class="font-semibold text-amber-900">Timeline</h2>
                            <span class="text-xs text-amber-700 bg-amber-100 px-2 py-1 rounded-full" id="remarks-count">0 items</span>
                        </div>
                        <div class="overflow-y-auto p-4 bg-gray-50 flex-grow">
                            <ul id="remarks-list" class="space-y-3"></ul>
                            <div id="no-remarks-msg" class="text-center text-gray-400 text-sm mt-10 hidden">No remarks yet.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8 mb-4 text-gray-400 text-xs">
                 synced via Google Firebase
            </div>
        </div>
    </div>

    <!-- MODULE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ---------------------------------------------------------
        // üî¥ FIREBASE CONFIGURATION üî¥
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBsmv9KXNLeuCJnccU2d6JgjLac4vIB_4M",
            authDomain: "dbms-dde2c.firebaseapp.com",
            projectId: "dbms-dde2c",
            storageBucket: "dbms-dde2c.firebasestorage.app",
            messagingSenderId: "844776091344",
            appId: "1:844776091344:web:25bee956e29d427a0df8d5"
        };
        // ---------------------------------------------------------

        // --- State & Data ---
        const lecturesData = [
            "Lec-1: DBMS Syllabus", "Lec-2: Introduction to DBMS", "Lec-3: File System vs DBMS", "Lec-4: 2 tier and 3 tier Architecture",
            "Lec-5: What is Schema", "Lec-6: Three Schema Architecture", "Lec-7: Data Independence", "Lec-8.0: Integrity Constraints",
            "Lec-8: Candidate & Primary Key", "Lec-9: Primary Key Examples", "Lec-10: Foreign Key Concept", "Lec-11: Foreign Key Operations",
            "Lec-12: Question on Foreign Key", "Lec-13: Super key", "Lec-14: Introduction to ER model", "Lec-15: Attributes in ER Model",
            "Lec-16: One to One relationship", "Lec-17: One to Many Relationship", "Lec-18: Many to Many Relationship", "Lec-19: Minimize tables in ER",
            "Lec-20: Normalization Intro", "Lec-21: 1NF", "Lec-22: Functional Dependency Closure", "Lec-23: Functional Dependency Properties",
            "Lec-24: 2NF", "Lec-25: 3NF", "Lec-26: BCNF", "Lec-27: BCNF Dependency Preserving?", "Lec-28: Lossless/Lossy & 5NF",
            "Lec-29: All Normal Forms Summary", "Lec-30: Minimal Cover", "Lec-31: Practice Normalization", "Lec-32: Finding Normal Form",
            "Lec-33: Solving Normalization Qs", "Lec-34: Imp Normalization Qs", "Lec-35: Functional Dependencies Equivalence",
            "Lec-36: Dependency Preserving Decomp", "Lec-37: Dep Preserving Decomp Ex 2", "Lec-38: Joins Intro", "Lec-39: Natural Join",
            "Lec-40: Self Join", "Lec-41: Equi Join", "Lec-42: Left Outer Join", "Lec-43: Right Outer Join", "Lec-44: Relational Algebra Intro",
            "Lec-45: Projection", "Lec-46: Selection", "Lec-47: Cross Product", "Lec-48: Set Difference", "Lec-49: Union", "Lec-50: Division",
            "Lec-51: Tuple Calculus", "Lec-52: SQL Intro", "Lec-53: SQL Commands", "Lec-54: Create Table", "Lec-55: ALTER Command",
            "Lec-56: Alter vs Update", "Lec-57: Delete, Drop, Truncate", "Lec-58: Constraints", "Lec-59: SQL Queries 1", "Lec-60: SQL Queries 2",
            "Lec-61: SQL Queries 3", "Lec-62: SQL Queries 4", "Lec-63: SQL Queries 5", "Lec-64: SQL Queries 6", "Lec-65: SQL Queries 7",
            "Lec-66: EXIST / NOT EXIST", "Lec-67: Aggregate Functions", "Lec-68: Correlated Subquery", "Lec-69: Joins vs Nested vs Correlated",
            "Lec-70: Nth Highest Salary", "Lec-71: 3 Imp Questions", "Lec-72: PL-SQL Intro", "Lec-73: Transaction Concurrency",
            "Lec-74: ACID Properties", "Lec-75: Transaction States", "Lec-76: Schedules", "Lec-77: Concurrency Problems", "Lec-78: Dirty Read",
            "Lec-79: Unrepeatable Read", "Lec-80: Recoverable Schedules", "Lec-81: Cascading/Cascadeless", "Lec-82: Serializability",
            "Lec-83: Conflict Equivalent", "Lec-84: Conflict Serializability", "Lec-85: View Serializability", "Lec-86: Shared Exclusive Locking",
            "Lec-87: Locking Drawbacks", "Lec-88: 2 Phase Locking", "Lec-89: 2PL Drawbacks", "Lec-90: Strict/Rigorous 2PL", "Lec-91: Timestamp Ordering",
            "Lec-92: Timestamp Qs", "Lec-93: Indexing Intro", "Lec-94: Indexing I/O Cost 1", "Lec-95: Indexing I/O Cost 2", "Lec-96: Types Of Indexes",
            "Lec-97: Primary Index", "Lec-98: Clustered Index", "Lec-99: Secondary Index", "Lec-100: B-Tree Intro", "Lec-101: B-Tree Insertion",
            "Lec-102: B-Tree Order", "Lec-103: B-Tree vs B+Tree", "Lec-104: Order of B+ Tree", "Lec-105: Immediate DB Mod", "Lec-106: Deferred DB Mod",
            "Lec-107: SQL Like", "Lec-108: PL-SQL Part 1", "Lec-109: PL-SQL Part 2", "Lec-110: Single/Multi row functions", "Lec-111: Character functions",
            "Lec-112: Views", "Lec-113: Aggregate on NULL", "Lec-114: RAID", "Lec-115: DB Objects", "Lec-116: ER Model Qs", "Lec-117: DBMS Basic Qs",
            "Lec-118: Joins Qs", "Lec-119: Advance DBMS Qs", "Lec-120: Normalization Qs", "Lec-121: Relational Algebra Qs", "Lec-122: Codd‚Äôs 12 Rules",
            "Lec-123: Top 15 Interview Qs", "Lec-124: CREATE DDL", "Lec-125: SEQUENCE", "Lec-126: SQL Execution Order", "Lec-127: Hadoop Intro",
            "Lec-128: Big Data Intro", "Lec-129: Types of Views", "Lec-130: FK Delete Cascade", "Lec-131: Procedures", "Lec-132: Fetch Data Proc",
            "Lec-133: Cursor", "Lec-134: %TYPE %ROWTYPE", "Lec-135: Weak Entity", "Lec-136: Rename Operator", "Lec-137: Non Correlated Subquery",
            "Lec-138: WITH Clause"
        ];

        const defaultConcepts = [
            { title: "Architecture & Basics", desc: "3-Schema Architecture, Data Independence, DDL/DML/DCL." },
            { title: "Keys & Constraints", desc: "Primary, Candidate, Super, Foreign Keys, Referential Integrity." },
            { title: "ER Modeling", desc: "Entities, Attributes, Relationships (1:1, 1:M, M:N), Weak Entities." },
            { title: "Normalization", desc: "1NF, 2NF, 3NF, BCNF. Lossless Join & Dependency Preservation." },
            { title: "Relational Algebra", desc: "Selection, Projection, Cartesian Product, Set Operations." },
            { title: "SQL Joins", desc: "Inner, Left, Right, Full Outer Joins, Self Join." },
            { title: "SQL Subqueries", desc: "Nested Queries, Correlated Subqueries, EXISTS/NOT EXISTS." },
            { title: "Transaction Management", desc: "ACID Properties (Atomicity, Consistency, Isolation, Durability)." },
            { title: "Concurrency Control", desc: "Serializability (Conflict/View), 2-Phase Locking (2PL), Deadlocks." },
            { title: "Indexing", desc: "B-Trees, B+ Trees (Structure & Order), Primary vs Secondary Index." }
        ];

        // --- App Logic ---
        let db, auth, docRef;
        let state = {
            checkedLectures: [],
            checkedConcepts: [],
            customConcepts: [],
            remarks: []
        };

        async function initFirebase() {
            // Basic check, but the detailed error will catch later
            if (!firebaseConfig.apiKey) {
                document.getElementById('config-warning').classList.remove('hidden');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                docRef = doc(db, "trackers", "dbms-shared-tracker");

                // Attempt Anonymous Sign In (This is likely where your error was)
                await signInAnonymously(auth);

                // Listen for real-time updates
                onSnapshot(docRef, (snap) => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    if (snap.exists()) {
                        state = snap.data();
                        // Merge defaults if missing to prevent errors
                        if(!state.customConcepts) state.customConcepts = [];
                        if(!state.remarks) state.remarks = [];
                    } else {
                        // Create if doesn't exist
                        saveState();
                    }
                    render();
                }, (error) => {
                    // This catches FIRESTORE PERMISSION errors (e.g., Test Mode not enabled)
                    console.error("Firestore Error:", error);
                    document.getElementById('loading-overlay').style.display = 'flex';
                    document.getElementById('loading-spinner').style.display = 'none';
                    document.getElementById('loading-text').innerText = "Database Permission Error";
                    const warning = document.getElementById('config-warning');
                    warning.classList.remove('hidden');
                    warning.innerHTML = `
                        ‚ö†Ô∏è <strong>Database Access Denied</strong><br>
                        Please go to Firebase Console > Firestore Database > Rules.<br>
                        Ensure "Test Mode" is enabled (or allow read/write).
                    `;
                });

            } catch (error) {
                // This catches AUTH errors (e.g., Anonymous auth not enabled)
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('loading-text').innerText = "Configuration Error";
                const warning = document.getElementById('config-warning');
                warning.classList.remove('hidden');
                
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                    warning.innerHTML = `
                        ‚ö†Ô∏è <strong>Authentication Disabled</strong><br>
                        <div class="text-left mt-2 text-sm">
                            1. Go to <a href="https://console.firebase.google.com/" target="_blank" class="underline font-bold">Firebase Console</a><br>
                            2. Click <strong>Build > Authentication</strong><br>
                            3. Click <strong>Sign-in method</strong> tab<br>
                            4. Enable <strong>"Anonymous"</strong> provider<br>
                        </div>
                    `;
                } else {
                    warning.innerHTML = `‚ö†Ô∏è <strong>Error:</strong> ${error.message}`;
                }
            }
        }

        function saveState() {
            if(docRef) {
                setDoc(docRef, state, { merge: true });
            }
        }

        // --- Render Logic ---
        function getStats() {
            const currentYear = new Date().getFullYear();
            const now = new Date();
            let startYear = currentYear;
            if (now.getMonth() < 2) startYear = currentYear - 1;
            else if (now.getMonth() > 10 && now.getDate() > 14) startYear = currentYear;

            const START_DATE = new Date(startYear, 10, 14);
            const END_DATE = new Date(startYear + 1, 1, 14);
            
            let effectiveToday = now < START_DATE ? START_DATE : now;
            if (effectiveToday > END_DATE) effectiveToday = END_DATE;

            const totalDuration = END_DATE - START_DATE;
            const elapsed = effectiveToday - START_DATE;
            
            let progressRatio = elapsed / totalDuration;
            progressRatio = Math.max(0, Math.min(1, progressRatio));

            const totalLectures = lecturesData.length;
            const targetIndex = Math.floor(progressRatio * totalLectures);
            const completedCount = state.checkedLectures.length;
            const remainingCount = totalLectures - completedCount;
            const msPerDay = 1000 * 60 * 60 * 24;
            const daysRemaining = Math.max(0, Math.ceil((END_DATE - now) / msPerDay));
            const videosPerDay = daysRemaining > 0 ? (remainingCount / daysRemaining).toFixed(1) : 0;

            return { targetIndex, completedCount, totalLectures, progressRatio, daysRemaining, videosPerDay };
        }

        function render() {
            const stats = getStats();
            
            // Stats
            document.getElementById('count-display').innerText = `${stats.completedCount}/${stats.totalLectures}`;
            document.getElementById('target-display').innerText = `Video #${stats.targetIndex + 1}`;
            document.getElementById('pace-display').innerText = stats.videosPerDay;
            document.getElementById('days-left-display').innerText = stats.daysRemaining;

            // Bars
            const percentComplete = (stats.completedCount / stats.totalLectures) * 100;
            document.getElementById('progress-fill').style.width = `${percentComplete}%`;
            document.getElementById('target-marker').style.left = `${stats.progressRatio * 100}%`;

            // Status Text
            const diff = stats.completedCount - (stats.targetIndex + 1);
            const statusText = document.getElementById('status-text');
            if (diff >= 0) {
                statusText.innerText = `Ahead by ${diff} videos`;
                statusText.className = "font-bold text-green-600";
                document.getElementById('progress-fill').className = "progress-bar-fill bg-green-500";
            } else {
                statusText.innerText = `Behind by ${Math.abs(diff)} videos`;
                statusText.className = "font-bold text-red-600";
                document.getElementById('progress-fill').className = "progress-bar-fill bg-blue-600";
            }

            // Lectures
            const listEl = document.getElementById('lecture-list');
            listEl.innerHTML = '';
            lecturesData.forEach((lec, idx) => {
                const isTarget = (idx === stats.targetIndex);
                const isChecked = state.checkedLectures.includes(idx);
                const li = document.createElement('li');
                li.className = `lecture-row p-4 flex items-start space-x-3 ${isTarget ? 'target-row' : ''}`;
                
                let html = `
                    <input type="checkbox" class="lecture-checkbox mt-1 h-4 w-4 text-blue-600 rounded cursor-pointer" 
                           ${isChecked ? 'checked' : ''} onclick="window.app.toggleLecture(${idx})">
                    <div class="flex-1 text-sm cursor-pointer" onclick="window.app.toggleLecture(${idx})">
                        <span class="font-medium mr-2 text-gray-400">#${idx+1}</span> ${lec}
                `;
                if(isTarget) {
                    html += `<br><span class="target-badge mt-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><i class="fas fa-map-marker-alt mr-1"></i> You should be here</span>`;
                    if(!window.hasScrolled) { setTimeout(() => li.scrollIntoView({behavior:"smooth", block:"center"}), 500); window.hasScrolled=true; }
                }
                html += `</div>`;
                li.innerHTML = html;
                listEl.appendChild(li);
            });

            // Concepts (Default + Custom)
            const conceptsEl = document.getElementById('concepts-list');
            conceptsEl.innerHTML = '';
            
            // Helper to render concept row
            const renderConcept = (c, idx, isCustom) => {
                const isChecked = state.checkedConcepts.includes(isCustom ? `c_${idx}` : `d_${idx}`);
                const li = document.createElement('li');
                li.className = `p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors`;
                li.innerHTML = `
                    <input type="checkbox" class="mt-1 h-5 w-5 text-indigo-600 rounded cursor-pointer" 
                           ${isChecked ? 'checked' : ''} onclick="window.app.toggleConcept(${idx}, ${isCustom})">
                    <div class="flex-1 cursor-pointer" onclick="window.app.toggleConcept(${idx}, ${isCustom})">
                        <div class="font-semibold text-gray-800 ${isChecked ? 'line-through text-gray-400' : ''}">${c.title}</div>
                        <div class="text-sm text-gray-500 ${isChecked ? 'line-through text-gray-300' : ''}">${c.desc}</div>
                    </div>
                    ${isCustom ? `<button onclick="window.app.deleteConcept(${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                `;
                conceptsEl.appendChild(li);
            };

            defaultConcepts.forEach((c, i) => renderConcept(c, i, false));
            state.customConcepts.forEach((c, i) => renderConcept(c, i, true));

            // Remarks
            const remarksEl = document.getElementById('remarks-list');
            const noMsg = document.getElementById('no-remarks-msg');
            document.getElementById('remarks-count').innerText = `${state.remarks.length} items`;
            remarksEl.innerHTML = '';
            
            if(state.remarks.length === 0) noMsg.classList.remove('hidden');
            else {
                noMsg.classList.add('hidden');
                state.remarks.forEach((r, idx) => {
                    const li = document.createElement('li');
                    li.className = `remark-card p-4 border border-gray-200 rounded-lg bg-white shadow-sm transition-all ${r.seen ? 'seen' : ''}`;
                    li.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="pt-1">
                                <input type="checkbox" ${r.seen ? 'checked' : ''} onclick="window.app.toggleRemarkSeen(${idx})"
                                    class="w-5 h-5 text-amber-600 rounded border-gray-300 cursor-pointer">
                            </div>
                            <div class="flex-grow">
                                <div class="remark-text text-gray-800 text-sm whitespace-pre-wrap mb-2 font-medium">${r.text}</div>
                                <div class="remark-meta flex justify-between items-center text-xs text-gray-400">
                                    <span><i class="far fa-clock mr-1"></i>${r.date}</span>
                                    <button onclick="window.app.deleteRemark(${idx})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    remarksEl.appendChild(li);
                });
            }
        }

        // --- Global Actions for HTML ---
        window.app = {
            toggleLecture: (idx) => {
                if(state.checkedLectures.includes(idx)) state.checkedLectures = state.checkedLectures.filter(i=>i!==idx);
                else state.checkedLectures.push(idx);
                saveState();
            },
            toggleConcept: (idx, isCustom) => {
                const id = isCustom ? `c_${idx}` : `d_${idx}`;
                if(state.checkedConcepts.includes(id)) state.checkedConcepts = state.checkedConcepts.filter(i=>i!==id);
                else state.checkedConcepts.push(id);
                saveState();
            },
            addConcept: () => {
                const t = document.getElementById('new-concept-title');
                const d = document.getElementById('new-concept-desc');
                if(t.value.trim()) {
                    state.customConcepts.push({title: t.value.trim(), desc: d.value.trim()});
                    t.value=''; d.value='';
                    saveState();
                }
            },
            deleteConcept: (idx) => {
                if(confirm("Delete custom concept?")) {
                    state.customConcepts.splice(idx, 1);
                    saveState();
                }
            },
            postRemark: () => {
                const t = document.getElementById('new-remark-text');
                if(t.value.trim()) {
                    const dateStr = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    state.remarks.unshift({ text: t.value.trim(), date: dateStr, seen: false });
                    t.value = '';
                    saveState();
                }
            },
            toggleRemarkSeen: (idx) => {
                state.remarks[idx].seen = !state.remarks[idx].seen;
                saveState();
            },
            deleteRemark: (idx) => {
                if(confirm("Delete remark?")) {
                    state.remarks.splice(idx, 1);
                    saveState();
                }
            }
        };

        window.ui = {
            switchTab: (name) => {
                ['lectures','concepts','remarks'].forEach(t => {
                    document.getElementById(`view-${t}`).classList.add('hidden');
                    document.getElementById(`tab-${t}`).classList.remove('active');
                });
                document.getElementById(`view-${name}`).classList.remove('hidden');
                document.getElementById(`tab-${name}`).classList.add('active');
            }
        };

        // --- Start ---
        initFirebase();
    </script>
</body>
</html>